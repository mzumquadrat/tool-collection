<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Convert YouTube channel or playlist URLs to RSS feed URLs">
    <title>YouTube RSS Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        .result-box {
            background-color: var(--card-background-color);
            border: 1px solid var(--muted-border-color);
            border-radius: 0.25rem;
            padding: 1rem;
            margin-top: 1rem;
            word-break: break-all;
        }

        .result-box.success {
            border-color: var(--form-element-valid-border-color);
            background-color: rgba(46, 125, 50, 0.1);
        }

        .result-box.error {
            border-color: var(--form-element-invalid-border-color);
            background-color: rgba(211, 47, 47, 0.1);
        }

        .copy-button {
            margin-top: 0.5rem;
            width: 100%;
        }

        .info-box {
            background-color: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-box h3 {
            margin-top: 0;
            font-size: 1rem;
        }

        .info-box ul {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>YouTube RSS Generator</h1>
            <p>Convert YouTube channel or playlist URLs to RSS feed URLs</p>
        </header>

        <section>
            <article class="info-box">
                <h3>ℹ️ About Shorts Filtering</h3>
                <p>Channel URLs are converted to uploads playlist feeds (UULF prefix) which may help reduce shorts in some RSS readers.</p>
            </article>

            <form id="rss-form">
                <fieldset>
                    <label for="youtube-url">
                        YouTube URL
                        <input 
                            id="youtube-url" 
                            type="url" 
                            placeholder="https://www.youtube.com/@channelname or playlist URL"
                            required
                            autofocus
                        >
                    </label>
                    <small>
                        Supported formats:
                        <ul>
                            <li>Channel: youtube.com/@handle, youtube.com/channel/ID, youtube.com/c/custom, youtube.com/user/username</li>
                            <li>Playlist: youtube.com/playlist?list=ID</li>
                        </ul>
                    </small>
                </fieldset>
                <button type="submit">Generate RSS Feed</button>
            </form>

            <div id="result-container" style="display: none;">
                <h2>RSS Feed URL</h2>
                <div id="result" class="result-box"></div>
                <button id="copy-button" class="copy-button">Copy to Clipboard</button>
            </div>
        </section>
    </main>

    <footer class="container">
        <a href="index.html">← Back to Tools</a>
    </footer>

    <script>
        const YouTubeRSS = (() => {
            const form = document.getElementById('rss-form');
            const urlInput = document.getElementById('youtube-url');
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            const copyButton = document.getElementById('copy-button');
            let currentRssUrl = '';

            /**
             * Extracts channel ID from various YouTube channel URL formats
             * @param {string} url - YouTube channel URL
             * @returns {Promise<string|null>} Channel ID or null if not found
             */
            const extractChannelId = async (url) => {
                // Format: /channel/UC...
                const channelMatch = url.match(/\/channel\/(UC[\w-]+)/);
                if (channelMatch) return channelMatch[1];

                // Format: /@handle - try to fetch and extract
                const handleMatch = url.match(/\/@([\w-]+)/);
                if (handleMatch) {
                    const handle = handleMatch[1];
                    try {
                        const channelId = await fetchChannelIdFromHandle(url);
                        if (channelId) return channelId;
                    } catch (error) {
                        console.error('Failed to fetch channel ID:', error);
                    }
                    return 'HANDLE:' + handle; // Mark as handle for special error handling
                }

                // Format: /c/customname or /user/username
                const customMatch = url.match(/\/(c|user)\/([\w-]+)/);
                if (customMatch) {
                    return 'CUSTOM:' + customMatch[2]; // Mark as custom for special error handling
                }

                return null;
            };

            /**
             * Fetches channel ID from @handle URL by parsing the page
             * @param {string} url - YouTube channel URL with @handle
             * @returns {Promise<string|null>} Channel ID or null
             */
            const fetchChannelIdFromHandle = async (url) => {
                try {
                    const response = await fetch(url);
                    const html = await response.text();
                    
                    // Try to extract channelId from various places in the HTML
                    const patterns = [
                        /"channelId":"(UC[\w-]+)"/,
                        /"browseId":"(UC[\w-]+)"/,
                        /<link rel="canonical" href="https:\/\/www\.youtube\.com\/channel\/(UC[\w-]+)">/,
                        /property="og:url" content="https:\/\/www\.youtube\.com\/channel\/(UC[\w-]+)"/
                    ];
                    
                    for (const pattern of patterns) {
                        const match = html.match(pattern);
                        if (match) {
                            return match[1];
                        }
                    }
                    
                    return null;
                } catch (error) {
                    return null;
                }
            };

            /**
             * Extracts playlist ID from YouTube playlist URL
             * @param {string} url - YouTube playlist URL
             * @returns {string|null} Playlist ID or null if not found
             */
            const extractPlaylistId = (url) => {
                const match = url.match(/[?&]list=([\w-]+)/);
                return match ? match[1] : null;
            };

            /**
             * Converts channel ID to uploads playlist ID
             * @param {string} channelId - YouTube channel ID starting with UC
             * @returns {string} Uploads playlist ID with UULF prefix
             */
            const channelToUploadsPlaylist = (channelId) => {
                if (!channelId.startsWith('UC')) {
                    throw new Error('Invalid channel ID format');
                }
                return 'UULF' + channelId.substring(2);
            };

            /**
             * Generates RSS feed URL from channel or playlist ID
             * @param {string} id - Channel ID or Playlist ID
             * @param {string} type - 'channel' or 'playlist'
             * @returns {string} RSS feed URL
             */
            const generateRssFeed = (id, type) => {
                if (type === 'channel') {
                    const playlistId = channelToUploadsPlaylist(id);
                    return `https://www.youtube.com/feeds/videos.xml?playlist_id=${playlistId}`;
                } else if (type === 'playlist') {
                    return `https://www.youtube.com/feeds/videos.xml?playlist_id=${id}`;
                }
                throw new Error('Invalid type');
            };

            /**
             * Shows error message
             * @param {string} message - Error message to display
             */
            const showError = (message) => {
                resultContainer.style.display = 'block';
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `<strong>Error:</strong> ${message}`;
                copyButton.style.display = 'none';
                currentRssUrl = '';
            };

            /**
             * Shows success message with RSS feed URL
             * @param {string} rssUrl - Generated RSS feed URL
             * @param {string} sourceType - Type of source (channel/playlist)
             */
            const showSuccess = (rssUrl, sourceType) => {
                resultContainer.style.display = 'block';
                resultDiv.className = 'result-box success';
                resultDiv.innerHTML = `
                    <p><strong>Source:</strong> ${sourceType}</p>
                    <p><strong>RSS Feed:</strong></p>
                    <code>${rssUrl}</code>
                `;
                copyButton.style.display = 'block';
                currentRssUrl = rssUrl;
            };

            /**
             * Processes the YouTube URL and generates RSS feed
             * @param {string} url - YouTube URL from user input
             */
            const processUrl = async (url) => {
                try {
                    // Normalize URL
                    url = url.trim();

                    // Check if it's a playlist URL
                    const playlistId = extractPlaylistId(url);
                    if (playlistId) {
                        const rssUrl = generateRssFeed(playlistId, 'playlist');
                        showSuccess(rssUrl, 'Playlist');
                        return;
                    }

                    // Check if it's a channel URL
                    const channelId = await extractChannelId(url);
                    if (channelId) {
                        // Check if it's a special marker for handles/custom URLs
                        if (channelId.startsWith('HANDLE:')) {
                            const handle = channelId.substring(7);
                            showError(`
                                Unable to automatically convert @${handle} to a channel ID due to browser restrictions.
                                <br><br>
                                <strong>How to get your RSS feed:</strong>
                                <ol>
                                    <li>Visit <a href="https://www.youtube.com/@${handle}" target="_blank">youtube.com/@${handle}</a></li>
                                    <li>Right-click the page and select "View Page Source" (or press Ctrl+U / Cmd+U)</li>
                                    <li>Press Ctrl+F / Cmd+F and search for <code>"channelId"</code></li>
                                    <li>Copy the ID that looks like <code>UC...</code></li>
                                    <li>Come back here and paste: <code>https://www.youtube.com/channel/UC...</code></li>
                                </ol>
                            `);
                            return;
                        }
                        
                        if (channelId.startsWith('CUSTOM:')) {
                            const custom = channelId.substring(7);
                            showError(`
                                Unable to automatically convert custom URL to a channel ID.
                                <br><br>
                                <strong>How to get your RSS feed:</strong>
                                <ol>
                                    <li>Visit the channel page</li>
                                    <li>Right-click and select "View Page Source" (or press Ctrl+U / Cmd+U)</li>
                                    <li>Search for <code>"channelId"</code></li>
                                    <li>Copy the ID that looks like <code>UC...</code></li>
                                    <li>Come back here and paste: <code>https://www.youtube.com/channel/UC...</code></li>
                                </ol>
                            `);
                            return;
                        }
                        
                        const rssUrl = generateRssFeed(channelId, 'channel');
                        showSuccess(rssUrl, 'Channel (converted to uploads playlist with UULF prefix)');
                        return;
                    }

                    // If we get here, the URL format wasn't recognized
                    showError(`
                        Could not extract channel or playlist ID from the URL.
                        <br><br>
                        Please use one of these formats:
                        <ul>
                            <li>youtube.com/@handle</li>
                            <li>youtube.com/channel/UC...</li>
                            <li>youtube.com/playlist?list=...</li>
                        </ul>
                    `);
                } catch (error) {
                    showError(error.message);
                }
            };

            /**
             * Copies the RSS URL to clipboard
             */
            const copyToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(currentRssUrl);
                    const originalText = copyButton.textContent;
                    copyButton.textContent = '✓ Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = currentRssUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyButton.textContent = '✓ Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy to Clipboard';
                        }, 2000);
                    } catch (err) {
                        alert('Failed to copy to clipboard');
                    }
                    document.body.removeChild(textArea);
                }
            };

            /**
             * Initializes the tool
             */
            const init = () => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const url = urlInput.value;
                    await processUrl(url);
                });

                copyButton.addEventListener('click', copyToClipboard);
            };

            return { init };
        })();

        document.addEventListener('DOMContentLoaded', YouTubeRSS.init);
    </script>
</body>
</html>
